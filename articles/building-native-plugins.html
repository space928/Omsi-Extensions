<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
    
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Building Native Omsi Plugins | OmsiHook </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="Building Native Omsi Plugins | OmsiHook ">
      <meta name="generator" content="docfx 2.56.7.0">
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/night-owl.min.css">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" integrity="sha384-EvBWSlnoFgZlXJvpzS+MAUEjvN7+gcCwH+qh7GRFOGgZO0PuwOFro7qPOJnLfe7l" crossorigin="anonymous">
      <link rel="stylesheet" href="../styles/config.css">
      <link rel="stylesheet" href="../styles/discord.css">
      <link rel="stylesheet" href="../styles/singulink.css">
      <link rel="stylesheet" href="../styles/main.css">
      <meta property="docfx:navrel" content="../toc.html">
      <meta property="docfx:tocrel" content="toc.html">
      
      <meta property="docfx:rel" content="../">
      <meta property="docfx:newtab" content="true">
    </head>
    <body>
        <div class="top-navbar">
            <a class="burger-icon" onclick="toggleMenu()">
                <svg name="Hamburger" style="vertical-align: middle;" width="34" height="34" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M20 6H4V9H20V6ZM4 10.999H20V13.999H4V10.999ZM4 15.999H20V18.999H4V15.999Z"></path></svg>
            </a>

            
            <a class="brand" href="../index.html">
              <img src="../images/logo.svg" alt="OmsiHook Documentation" class="logomark">
              <span class="brand-title">OmsiHook Documentation</span>
            </a>        </div>

        <div class="body-content">
            <div id="blackout" class="blackout" onclick="toggleMenu()"></div>

            <nav id="sidebar" role="navigation">
                <div class="sidebar">
                    
                    <div>
                      <div class="mobile-hide">
                        
                        <a class="brand" href="../index.html">
                          <img src="../images/logo.svg" alt="OmsiHook Documentation" class="logomark">
                          <span class="brand-title">OmsiHook Documentation</span>
                        </a>  </div>

                      <div class="sidesearch">
                        <form id="search" role="search" class="search">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="search-query" placeholder="Search" autocomplete="off">
                        </form>
                      </div>
                    
                      <div id="navbar">
                      </div>
                    </div>                    <div class="sidebar-item-separator"></div>
                        
                        <div id="sidetoggle">
                          <div id="sidetoc"></div>
                        </div>
                </div>
                <div class="footer">
                  <strong>DocFX + OmsiHook = ♥</strong>
                  
                </div>            </nav>

            <main class="main-panel">
                
                <div id="search-results" style="display: none;">
                  <h1 class="search-list">Search Results for <span></span></h1>
                  <div class="sr-items">
                    <p><i class="bi bi-hourglass-split index-loading"></i></p>
                  </div>
                  <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
                </div>
                <div role="main" class="hide-when-search">
                        
                        <div class="subnav navbar navbar-default">
                          <div class="container hide-when-search" id="breadcrumb">
                            <ul class="breadcrumb">
                              <li></li>
                            </ul>
                          </div>
                        </div>

                    <article class="content wrap" id="_content" data-uid="">
<h1 id="building-native-omsi-plugins">Building Native Omsi Plugins</h1>

<p>Some features of OmsiHook such as remote method calls require the library using OmsiHook to be running as a
native Omsi plugin. This guide covers some of the basics of building a native Omsi plugin using .NET 5.
An example plugin is available at
<a href="https://github.com/space928/Omsi-Extensions/tree/main/OmsiHookPlugin">https://github.com/space928/Omsi-Extensions/tree/main/OmsiHookPlugin</a>.</p>
<h2 id="overview-of-omsi-plugins">Overview of Omsi Plugins</h2>
<p>DLLs placed in Omsi's <code>\plugins\</code> folder with an accompanying <code>.opl</code> file will be loaded on startup as plugins.
The <code>.opl</code> file is an INI file containing the name of the DLL to load and the ordered lists of variables
accessed by the plugin.</p>
<h4 id="opl-files">OPL Files</h4>
<p>An example <code>.opl</code> file might look like this:</p>
<pre><code class="lang-ini">[dll]
OmsiHookPluginNE.dll

[varlist]
1
door_0

[stringvarlist]
3
INEO_DataTransferVehicleNumber
INEO_DataTransferDelay
INEO_DataTransferPassengerCount

[systemvarlist]
4
Time
Day
Month
Year

[triggers]
1
bus_doorfront0
</code></pre>
<p>The only required tag in the <code>.opl</code> file is the <code>[dll]</code> tag, which specifies the name of the DLL to load.
The other tags in this example specify which Omsi variables and triggers to pass to the plugin. The first
parameter of each of these tags is the number of variables in the list, followed by the name of each variable,
one on each line.</p>
<h4 id="dll-files">DLL Files</h4>
<p>Omsi requires that plugins export certain methods, all the required methods must be exported (even if they don't
do anything) for the plugin to be loaded.</p>
<p>Exported methods (C#):</p>
<pre><code class="lang-csharp">[UnmanagedCallersOnly(CallConvs = new[] { typeof(CallConvCdecl) })]
public static void PluginStart(IntPtr aOwner) {}

[UnmanagedCallersOnly(CallConvs = new[] { typeof(CallConvCdecl) })]
public static void PluginFinalize() {}

[UnmanagedCallersOnly(CallConvs = new[] { typeof(CallConvCdecl) })]
public static void AccessVariable(ushort variableIndex, [C99Type(&quot;float*&quot;)] IntPtr value, [C99Type(&quot;__crt_bool*&quot;)] IntPtr writeValue)

[UnmanagedCallersOnly(CallConvs = new[] { typeof(CallConvCdecl) })]
public static void AccessTrigger(ushort variableIndex, [C99Type(&quot;__crt_bool*&quot;)] IntPtr triggerScript) { }

[UnmanagedCallersOnly(CallConvs = new[] { typeof(CallConvCdecl) })]
public static void AccessStringVariable(ushort variableIndex, [C99Type(&quot;char*&quot;)] IntPtr firstCharacterAddress, [C99Type(&quot;__crt_bool*&quot;)] IntPtr writeValue) { }

[UnmanagedCallersOnly(CallConvs = new[] { typeof(CallConvCdecl) })]
public static void AccessSystemVariable(ushort variableIndex, [C99Type(&quot;float*&quot;)] IntPtr value, [C99Type(&quot;__crt_bool*&quot;)] IntPtr writeValue) { }
</code></pre>
<p>In this example, the exported methods have been written in C# with necessary attributes decorating the methods so
that they get exported correctly later when we include the native export library.</p>
<h2 id="setting-up-a-net-5-project-to-use-as-a-plugin">Setting Up a .NET 5 Project to Use as a Plugin</h2>
<ol>
<li>Create a new .NET 5 project with an output type of <code>Class Library</code>.</li>
<li>Install the <a href="https://www.nuget.org/packages/DNNE/">DNNE</a> NuGet package.</li>
<li>Install the <a href="https://www.nuget.org/packages/OmsiHook/">OmsiHook</a> NuGet package.</li>
<li>Set the platform target to <code>x86</code> (Omsi runs exclusively in 32 bit and as such, so must your plugin).</li>
<li>Edit your <code>.csproj</code> file to include necessary properties for DNNE to build (see the
<a href="https://github.com/AaronRobinsonMSFT/DNNE">DNNE github</a> for more details on how to setup native exports):</li>
</ol>
<pre><code class="lang-xml">&lt;PropertyGroup&gt;
    &lt;!-- Platform target must be set to x86 to be loaded by Omsi --&gt;
    &lt;PlatformTarget&gt;x86&lt;/PlatformTarget&gt;
&lt;/PropertyGroup&gt;
&lt;PropertyGroup&gt;
    &lt;EnableDynamicLoading&gt;true&lt;/EnableDynamicLoading&gt;
    &lt;DnneGenerateExports&gt;true&lt;/DnneGenerateExports&gt;
    &lt;DnneBuildExports&gt;true&lt;/DnneBuildExports&gt;
    &lt;DnneNativeBinaryName&gt;&lt;/DnneNativeBinaryName&gt;
    &lt;DnneMSBuildLogging&gt;low&lt;/DnneMSBuildLogging&gt;
    &lt;DnneAddGeneratedBinaryToProject&gt;false&lt;/DnneAddGeneratedBinaryToProject&gt;
    &lt;!-- Enable a workaround for https://github.com/dotnet/sdk/issues/1675 --&gt;
    &lt;DnneWorkAroundSdk1675&gt;true&lt;/DnneWorkAroundSdk1675&gt;
    &lt;DnneRuntimeIdentifier&gt;win-x86&lt;/DnneRuntimeIdentifier&gt;
    &lt;DnneSelfContained_Experimental&gt;false&lt;/DnneSelfContained_Experimental&gt;
&lt;/PropertyGroup&gt;
&lt;Target Name=&quot;PostBuild&quot; AfterTargets=&quot;PostBuildEvent&quot;&gt;
    &lt;!-- Optional --&gt;
    &lt;!-- Copy the built DLLs to the Omsi Plugins folder. NOTE: Make sure the path to Omsi is correct for your machine --&gt;
    &lt;Exec Command=&quot;xcopy &amp;quot;$(SolutionDir)Debug\*.dll&amp;quot; &amp;quot;$(OutDir)&amp;quot; /y&amp;#xD;&amp;#xA;xcopy &amp;quot;$(SolutionDir)Release\*.dll&amp;quot; &amp;quot;$(OutDir)&amp;quot; /y&amp;#xD;&amp;#xA;xcopy &amp;quot;$(OutDir)*.dll&amp;quot; &amp;quot;C:\Program Files (x86)\Steam\steamapps\common\OMSI 2\plugins\&amp;quot; /y&amp;#xD;&amp;#xA;xcopy &amp;quot;$(OutDir)*.opl&amp;quot; &amp;quot;C:\Program Files (x86)\Steam\steamapps\common\OMSI 2\plugins\&amp;quot; /y&amp;#xD;&amp;#xA;xcopy &amp;quot;$(OutDir)*.json&amp;quot; &amp;quot;C:\Program Files (x86)\Steam\steamapps\common\OMSI 2\plugins\&amp;quot; /y&quot; /&gt;
&lt;/Target&gt;
</code></pre>
<ol start="6">
<li>Ensure that you have the correct dependencies installed on your computer to build the project. See:
<a href="https://github.com/AaronRobinsonMSFT/DNNE#requirements">DNNE Requirements</a>.</li>
<li>Download <a href="https://github.com/AaronRobinsonMSFT/DNNE/blob/master/test/ExportingAssembly/Dnne.Attributes.cs">Dnne.Attributes.cs</a>
and add it to your project.</li>
<li>Create your main plugin file and add all the needed exported methods (see <a href="#dll-files">DLL Files</a> for an example).</li>
<li>Create an <code>.opl</code> file (see <a href="#opl-files">OPL Files</a> for an example); The default name of the exported DLL will be
<code>&lt;ProjectName&gt;NE.dll</code> ie: for a project called <code>OmsiHookPlugin</code>, the DLL will be <code>OmsiHookPluginNE.dll</code>. This can
be customised using the DNNE project properties.</li>
<li>Build your project! If everything was done correctly your Omsi plugins folder should now contain at least:
<ul>
<li><code>&lt;ProjectName&gt;.dll</code></li>
<li><code>&lt;ProjectName&gt;NE.dll</code></li>
<li><code>OmsiHook.dll</code></li>
<li><code>&lt;ProjectName&gt;.opl</code></li>
<li><code>&lt;ProjectName&gt;.runtimeconfig.json</code></li>
<li>If you use remote method calls: <code>OmsiHookInvoker.dll</code></li>
</ul>
</li>
</ol>
</article>
                </div>

                <div class="copyright-footer">
                    <span>&#169; Thomas/Adam Mathieson. All rights reserved.</span>
                </div>
            </main>
        </div>

        
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
        <script type="text/javascript" src="../styles/jquery.twbsPagination.js"></script>
        <script type="text/javascript" src="../styles/url.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>
        <script type="text/javascript" src="../styles/docfx.js"></script>
        <script type="text/javascript" src="../styles/singulink.js"></script>
        <script type="text/javascript" src="../styles/main.js"></script>    </body>
</html>
